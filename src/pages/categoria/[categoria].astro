---
import Layout from '../../layouts/Layout.astro';
import ProductList from '../../components/ProductList.tsx';
import { allCategories } from '../../data/categories.js';
import allProducts from '../../data/products.json';

// Generar rutas estáticas
export function getStaticPaths() {
    return allCategories.map(cat => ({
        params: { categoria: cat.id }
    }));
}

const { categoria } = Astro.params;

// Buscar la categoría
const categoryData = allCategories.find(cat => cat.id === categoria);

// Si no existe la categoría, redirigir a 404
if (!categoryData) {
    return Astro.redirect('/404');
}

// Subcategorías para el filtro
const subcategories = categoryData.subcategories?.map((sub: any) => ({ 
    id: sub.id, 
    label: sub.label 
})) || [];

// Filtrar productos por marca y mapear solo campos necesarios
const categoryLabel = categoryData.label.toLowerCase();
const productos = allProducts
    .filter((product: any) => {
        const productBrand = product.brand?.toLowerCase() || '';
        const productName = product.name?.toLowerCase() || '';
        return productBrand.includes(categoryLabel) || productName.includes(categoryLabel);
    })
    .map((p: any) => ({
        id: p.id,
        name: p.name,
        brand: p.brand,
        price: p.price,
        priceFormatted: p.priceFormatted,
        image: p.image,
        featured: p.featured,
        bestSeller: p.bestSeller,
        onSale: p.onSale,
        backInStock: p.backInStock
    }));
---

<Layout title={categoryData.label}>
    <main>
        <ProductList 
            client:idle
            products={productos} 
            title={categoryData.label}
            showFilters={true}
            categories={subcategories}
        />
    </main>
</Layout>
