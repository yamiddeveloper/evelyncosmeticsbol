---
import Layout from '../../../layouts/Layout.astro';
import ProductList from '../../../components/ProductList.tsx';
import { allCategories } from '../../../data/categories.js';
import allProducts from '../../../data/products.json';

// Generar rutas estáticas para todas las subcategorías
export function getStaticPaths() {
    const paths: { params: { categoria: string; subcategoria: string } }[] = [];
    
    allCategories.forEach(cat => {
        if (cat.subcategories && cat.subcategories.length > 0) {
            cat.subcategories.forEach(sub => {
                paths.push({
                    params: { 
                        categoria: cat.id, 
                        subcategoria: sub.id 
                    }
                });
            });
        }
    });
    
    return paths;
}

const { categoria, subcategoria } = Astro.params;

// Buscar la categoría padre
const categoryData = allCategories.find(cat => cat.id === categoria);

// Si no existe la categoría, redirigir a 404
if (!categoryData) {
    return Astro.redirect('/404');
}

// Buscar la subcategoría
const subcategoryData = categoryData.subcategories?.find((sub: any) => sub.id === subcategoria);

// Si no existe la subcategoría, redirigir a 404
if (!subcategoryData) {
    return Astro.redirect('/404');
}

// Filtrar productos por categoría y subcategoría
const categoryLabel = categoryData.label.toLowerCase();
const subcategoryLabel = subcategoryData.label.toLowerCase();

const productos = allProducts.filter((product: any) => {
    const productName = product.name?.toLowerCase() || '';
    const productDescription = product.description?.toLowerCase() || '';
    const productBrand = product.brand?.toLowerCase() || '';
    
    // Buscar coincidencias con la categoría o subcategoría
    const matchesCategory = productBrand.includes(categoryLabel) || productName.includes(categoryLabel);
    const matchesSubcategory = productName.includes(subcategoryLabel) || productDescription.includes(subcategoryLabel);
    
    return matchesCategory || matchesSubcategory;
});
---

<Layout title={`${subcategoryData.label} - ${categoryData.label}`}>
    <main>
        <ProductList 
            client:load
            products={productos} 
            title={subcategoryData.label}
            showFilters={true}
        />
    </main>
</Layout>
