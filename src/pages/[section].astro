---
import Layout from '../layouts/Layout.astro';
import ProductList from '../components/ProductList.tsx';
import { sections, getAllCategoriesFlat } from '../data/categories.js';
import allProducts from '../data/products.json';

// Generar rutas estáticas
export function getStaticPaths() {
    return Object.keys(sections).map(sectionKey => ({
        params: { section: sectionKey }
    }));
}

const { section } = Astro.params;

// Obtener configuración de la sección
const sectionConfig = sections[section];

// Si no existe la sección, redirigir a 404
if (!sectionConfig) {
    return Astro.redirect('/404');
}

// Filtrar productos según la sección
let filteredProducts: any[] = [];
let categories: { id: string; label: string }[] = [];

if (sectionConfig.isCategories) {
    // Para "Por Necesidad", mostrar categorías
    const allCats = getAllCategoriesFlat();
    categories = allCats.map((cat: any) => ({ id: cat.id, label: cat.label }));
} else {
    // Filtrar productos según el filterKey y mapear solo campos necesarios
    filteredProducts = allProducts
        .filter((product: any) => product[sectionConfig.filterKey] === true)
        .map((product: any) => ({
            id: product.id,
            name: product.name,
            brand: product.brand,
            price: product.price,
            priceFormatted: product.priceFormatted,
            image: product.image,
            featured: product.featured,
            bestSeller: product.bestSeller,
            onSale: product.onSale,
            backInStock: product.backInStock
        }));
}
---

<Layout title={sectionConfig.titulo}>
    <main>
        <ProductList 
            client:idle
            products={filteredProducts} 
            title={sectionConfig.titulo}
            showFilters={!sectionConfig.isCategories}
            categories={categories}
        />
    </main>
</Layout>
